FROM quay.io/stonevil/alpine-glibc
MAINTAINER stonevil@gmail.com

ENV KIBANA_VERSION=${KIBANA_VERSION:-4.5.1}
ENV KIBANA_DOWNLOAD_URL=${KIBANA_DOWNLOAD_URL:-https://download.elastic.co/kibana/kibana/kibana-$KIBANA_VERSION-linux-x64.tar.gz}
ENV KIBANA_BASE_PATH=/opt
ENV KIBANA_PATH ${KIBANA_BASE_PATH}/kibana
ENV PATH ${KIBANA_PATH}/bin:$PATH

LABEL com.stonevil.kibana.version=${KIBANA_VERSION}

RUN mkdir -p /${KIBANA_BASE_PATH} && \
  ${APK_INSTALL_CMD} libstdc++ && \
  ${SOFTWARE_DOWNLOAD_CMD} ${KIBANA_DOWNLOAD_URL} | tar -zxvf - -C ${KIBANA_BASE_PATH} && \
  mv ${KIBANA_BASE_PATH}/kibana-${KIBANA_VERSION}-linux-x64 ${KIBANA_PATH} && \
  rm -rf $(find ${KIBANA_PATH} | egrep "(\.(exe|bat)$|sigar/.*(dll|winnt|x86-linux|solaris|ia64|freebsd|macosx))") && \
  adduser -D -H -h /data/kibana -s /bin/bash kibana && \
  chown -Rf kibana ${KIBANA_PATH} && \
  ${APK_CACHE_RM}

ADD _rootfs /
ONBUILD ADD _rootfs_vendor /

EXPOSE 5601

VOLUME ["/data/kibana"]

ENV ELASTIC_URL=${ELASTIC_URL:-http://localhost:9200}
ENV ELASTIC_USERNAME=${ELASTIC_USERNAME}
ENV ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
ENV ELASTIC_PRESERVEHOST=${ELASTIC_PRESERVEHOST:-true}
ENV ELASTIC_PINGTIMEOUT=${ELASTIC_PINGTIMEOUT:-1500}
ENV ELASTIC_REQUESTTIMEOUT=${ELASTIC_REQUESTTIMEOUT:-300000}
ENV ELASTIC_SHARDTIMEOUT=${ELASTIC_SHARDTIMEOUT:-0}
ENV ELASTIC_STARTUPTIMEOUT=${ELASTIC_STARTUPTIMEOUT:-5000}

ENV KIBANA_SERVER_BASEPATH=${KIBANA_SERVER_BASEPATH}
ENV KIBANA_DEFAULTAPPID=${KIBANA_DEFAULTAPPID:-discover}

CMD mkdir -p /data/kibana; chown -fR kibana:kibana /data/kibana ${KIBANA_PATH} && \
  sed -i -e 's|_ELASTICURL_|'"${ELASTIC_URL}"'|g' -e 's|_ELASTICUSERNAME_|'"${ELASTIC_USERNAME}"'|g' -e 's|_ELASTICPASSWORD_|'"${ELASTIC_PASSWORD}"'|g' -e 's|_ELASTICPRESERVEHOST_|'"${ELASTIC_PRESERVEHOST}"'|g' -e 's|_ELASTICPINGTIMEOUT_|'"${ELASTIC_PINGTIMEOUT}"'|g' -e 's|_ELASTICREQUESTTIMEOUT_|'"${ELASTIC_REQUESTTIMEOUT}"'|g' -e 's|_ELASTICSHARDTIMEOUT_|'"${ELASTIC_SHARDTIMEOUT}"'|g' -e 's|_ELASTICSTARTUPTIMEOUT_|'"${ELASTIC_STARTUPTIMEOUT}"'|g' -e 's|_KIBANASERVERBASEPATH_|'"${KIBANA_SERVER_BASEPATH}"'|g' -e 's|_KIBANADEFAULTAPPID_|'"${KIBANA_DEFAULTAPPID}"'|g' ${KIBANA_PATH}/config/kibana.yml && \
  cd ${KIBANA_PATH} && gosu kibana ./bin/kibana
